<!doctype html>
<html lang="nb" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bulldøk — Treningsøkter</title>
    <meta name="description" content="Registrer og administrer treningsøkter for studentenes klatreklubb." />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>
      // Enable dark mode if user prefers
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
            colors: {
              brand: {
                50: '#f3faf9', 100: '#d7f3ef', 200: '#b0e7de', 300: '#7fd6c8',
                400: '#49bfae', 500: '#2aa390', 600: '#1e8274', 700: '#1b665d',
                800: '#174f49', 900: '#123f3a'
              }
            }
          }
        },
        darkMode: 'class'
      }
    </script>
    <style>
      html, body { height: 100%; }
      .toggle-registered, .toggle-attended { 
        width: 1.5rem; height: 1.5rem; border-radius: 0.25rem; 
        border: 1px solid #d1d5db; display: flex; align-items: center; 
        justify-content: center; color: #9ca3af; transition: all 0.2s;
      }
      .toggle-registered, .toggle-attended:hover { background-color: #f3f4f6; }
      .toggle-registered.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
      .toggle-attended.active { background-color: #10b981; color: white; border-color: #10b981; }
      .past-session { opacity: 0.9; }
      .future-session { opacity: 0.6; }
      .dark .toggle-registered, .dark .toggle-attended { border-color: #4b5563; }
      .dark .toggle-registered:hover, .dark .toggle-attended:hover { background-color: #1f2937; }
    </style>
  </head>
  <body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
    <div class="min-h-full flex flex-col">
      <!-- Top bar -->
      <header class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-gray-950/70 border-b border-gray-200 dark:border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-3">
              <div class="p-2 rounded-lg bg-brand-600 text-white">
                <!-- Climbing icon -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M11.7 2.1a1 1 0 0 1 1.3.6l.9 2.3 2.6.7a1 1 0 0 1 .2 1.9l-2.2.9-2.2 5.6 2.3 3.6a1 1 0 0 1-.3 1.4l-3.3 2.1a1 1 0 0 1-1.5-.5l-1.1-3.4-2.7-1.1a1 1 0 0 1-.3-1.7l2.5-2 .9-4.1-1.8-1.7a1 1 0 0 1 .4-1.7l3.8-1.2Z"/></svg>
              </div>
              <div>
                <h1 class="text-lg font-semibold leading-tight">Bulldøk</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 -mt-1">Treningsregistrering</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <!-- Google Login Button -->
              <button id="googleLoginBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-900/40">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5">
                  <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span id="loginStatus" class="text-sm">Login med Google</span>
              </button>
              
              <button id="adminLoginBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-200 dark:border-gray-800 hover:bg-gray-100 dark:hover:bg-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 7C13.1 7 14 7.9 14 9C14 10.1 13.1 11 12 11C10.9 11 10 10.1 10 9C10 7.9 10.9 7 12 7ZM12 13C13.5 13 16 13.75 16 15.25V17H8V15.25C8 13.75 10.5 13 12 13Z"/></svg>
                <span id="adminStatus" class="text-sm">Admin Login</span>
              </button>
              <button id="themeToggle" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-200 dark:border-gray-800 hover:bg-gray-100 dark:hover:bg-gray-900">
                <span class="sr-only">Bytt tema</span>
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden dark:block"><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm0 4a1 1 0 0 1-1-1v-1.2a1 1 0 1 1 2 0V21a1 1 0 0 1-1 1Zm0-20a1 1 0 0 0-1 1v1.2a1 1 0 1 0 2 0V3a1 1 0 0 0-1-1ZM3 11a1 1 0 0 0-1 1 1 1 0 1 0 2 0 1 1 0 0 0-1-1Zm18 0a1 1 0 0 0-1 1 1 1 0 1 0 2 0 1 1 0 0 0-1-1ZM4.2 4.2a1 1 0 1 0-1.4 1.4l.9.9a1 1 0 1 0 1.4-1.4l-.9-.9Zm15 15a1 1 0 0 0-1.4 0l-.9.9a1 1 0 1 0 1.4 1.4l.9-.9a1 1 0 0 0 0-1.4ZM4.2 19.8a1 1 0 1 0 1.4 1.4l.9-.9a1 1 0 1 0-1.4-1.4l-.9.9Zm15-15-1 .9a1 1 0 1 0 1.4 1.4l.9-.9a1 1 0 1 0-1.4-1.4Z"/></svg>
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 dark:hidden"><path d="M21.6 14.6a9 9 0 1 1-12.2-12 1 1 0 0 1 1.2 1.4A7 7 0 0 0 20 13.3a1 1 0 0 1 1.7 1.3Z"/></svg>
              </button>
            </div>
          </div>
        </div>
        <!-- Tabs -->
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex gap-2 pb-2 overflow-x-auto">
            <button data-tab="register" class="tab-btn active">Oppmøte</button>
            <button data-tab="myattendance" class="tab-btn">Registrer Treninger</button>
            <button data-tab="reports" class="tab-btn">Leaderboard</button>
            <button data-tab="members" class="tab-btn">Medlemmer</button>
            <button data-tab="sessions" class="tab-btn">Økter</button>
            <button data-tab="io" class="tab-btn">Import/Eksport</button>
          </div>
        </nav>
      </header>

      <!-- Content -->
      <main class="flex-1">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
          <!-- Registration View -->
          <section id="view-register" class="view">
            <div class="grid gap-6">
              <!-- Available sessions (full width) -->
              <div class="w-full">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Tilgjengelige økter</h2>
                    <input id="registerSessionSearch" type="search" placeholder="Søk økter" class="input">
                  </div>
                  <div id="registerSessionsList" class="divide-y divide-gray-100 dark:divide-gray-800">
                    <!-- Fallback content for when JavaScript hasn't loaded yet -->
                    <div class="p-6 text-center text-gray-500">Laster økter...</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Sessions View -->
          <section id="view-sessions" class="view hidden">
            <div class="grid gap-6 lg:grid-cols-3">
              <!-- Create session form -->
              <div class="lg:col-span-1">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Opprett økt</h2>
                    <p class="card-subtitle">Legg til ny treningsøkt</p>
                  </div>
                  <div id="sessionFormContainer">
                    <div id="sessionAdminRequired" class="p-4 text-center">
                      <div class="mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 mx-auto text-gray-400 mb-2"><path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 7C13.1 7 14 7.9 14 9C14 10.1 13.1 11 12 11C10.9 11 10 10.1 10 9C10 7.9 10.9 7 12 7ZM12 13C13.5 13 16 13.75 16 15.25V17H8V15.25C8 13.75 10.5 13 12 13Z"/></svg>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">Admin tilgang påkrevd</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Du må logge inn som admin for å opprette økter</p>
                      </div>
                      <button onclick="document.getElementById('adminLoginBtn').click()" class="btn-primary">Logg inn som admin</button>
                    </div>
                    <form id="sessionForm" class="space-y-4 p-4 hidden">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="label">Dato</label>
                          <input type="date" name="date" required class="input" />
                        </div>
                        <div>
                          <label class="label">Sted</label>
                          <input type="text" name="location" placeholder="Grip Sluppen" class="input" required />
                        </div>
                        <div>
                          <label class="label">Start</label>
                          <input type="time" name="start" value="19:00" required class="input" />
                        </div>
                        <div>
                          <label class="label">Slutt</label>
                          <input type="time" name="end" value="23:00" class="input" />
                        </div>
                        <div>
                          <label class="label">Disiplin</label>
                          <select name="discipline" class="input">
                            <option value="Bouldering">Buldre</option>
                            <option value="Top-rope">Topptau</option>
                            <option value="Lead">Led</option>
                            <option value="Strength/Conditioning">Styrke/kondisjon</option>
                          </select>
                        </div>
                        <div>
                          <label class="label">Kapasitet</label>
                          <input type="number" name="capacity" min="0" placeholder="Ingen grense" class="input" />
                        </div>
                      </div>
                      <div>
                        <label class="label">Notater</label>
                        <textarea name="notes" rows="3" class="input" placeholder="Plan, utstyr, mål..."></textarea>
                      </div>
                      <div class="flex justify-end">
                        <button class="btn-primary" type="submit">Opprett økt</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Sessions list -->
              <div class="lg:col-span-2">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Kommende økter</h2>
                    <div class="flex items-center gap-2">
                      <input id="sessionSearch" type="search" placeholder="Søk" class="input">
                      <select id="sessionFilter" class="input">
                        <option value="all">Alle</option>
                        <option value="Bouldering">Buldre</option>
                        <option value="Top-rope">Topptau</option>
                        <option value="Lead">Led</option>
                        <option value="Strength/Conditioning">Styrke/kondisjon</option>
                      </select>
                    </div>
                  </div>
                  <div id="sessionsList" class="divide-y divide-gray-100 dark:divide-gray-800"></div>
                </div>
              </div>
            </div>
          </section>

          <!-- Members View -->
          <section id="view-members" class="view hidden">
            <div class="grid gap-6 lg:grid-cols-3">
              <div class="lg:col-span-1">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Legg til medlem</h2>
                    <p class="card-subtitle">Opprett et klubbmedlem</p>
                  </div>
                  <form id="memberForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="label">Navn</label>
                        <input type="text" name="name" required class="input" />
                      </div>
                      <div>
                        <label class="label">E-post</label>
                        <input type="email" name="email" class="input" />
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div class="col-span-2">
                        <label class="label">PR (høyeste grad/farge)</label>
                        <input type="text" name="pr" class="input" placeholder="f.eks. V5 / Blå / 6b" />
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div class="flex items-center gap-2">
                        <input id="belay" type="checkbox" name="belay" class="checkbox" />
                        <label for="belay" class="label !m-0">Brattkort</label>
                      </div>
                      <div>
                        <label class="label">Nødtelefon</label>
                        <input type="tel" name="emergency" class="input" />
                      </div>
                    </div>
                    <div>
                      <label class="label">Notater</label>
                      <textarea name="notes" rows="3" class="input" placeholder="Allergier, skader, preferanser..."></textarea>
                    </div>
                    <div class="flex justify-end">
                      <button class="btn-primary" type="submit">Legg til medlem</button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="lg:col-span-2">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Medlemmer</h2>
                    <input id="memberSearch" type="search" placeholder="Søk" class="input">
                  </div>
                  <div id="membersList" class="divide-y divide-gray-100 dark:divide-gray-800"></div>
                </div>
              </div>
            </div>
          </section>

          <!-- Attendance View -->
          <section id="view-attendance" class="view hidden">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Påmelding</h2>
                 <div class="flex items-center gap-2">
                   <select id="attendanceSessionSelect" class="input"></select>
                  <button id="attendanceAddMemberBtn" class="btn-secondary">Legg til medlem</button>
                  <button id="attendanceSaveBtn" class="btn-primary">Lagre</button>
                 </div>
               </div>
               <div class="p-4">
                <div id="attendanceEmpty" class="text-sm text-gray-500 dark:text-gray-400">Velg en økt for å registrere oppmøte.</div>
                 <div id="attendanceTableWrap" class="hidden overflow-x-auto">
                   <table class="min-w-full text-sm">
                     <thead class="text-left text-gray-500 dark:text-gray-400">
                       <tr>
                        <th class="py-2 pr-4">Medlem</th>
                        <th class="py-2 pr-4">Påmeldt</th>
                        <th class="py-2 pr-4">Møtte</th>
                        <th class="py-2 pr-4">Notater</th>
                         <th class="py-2"></th>
                       </tr>
                     </thead>
                     <tbody id="attendanceTable" class="align-top"></tbody>
                   </table>
                 </div>
               </div>
             </div>
           </section>

          <!-- My Attendance View -->
          <section id="view-myattendance" class="view hidden">
            <div class="grid gap-6 lg:grid-cols-4">
              <!-- User info and stats -->
              <div class="lg:col-span-1">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Dine økter</h2>
                    <p class="card-subtitle">Oversikt over dine treningsøkter</p>
                  </div>
                  <div class="p-4">
                    <!-- Login required message -->
                    <div id="myAttendanceLoginRequired" class="text-center">
                      <div class="mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 mx-auto text-gray-400 mb-2">
                          <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd" />
                        </svg>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">Logg inn for å se dine økter</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Du må være logget inn for å se dine treningsøkter</p>
                      </div>
                      <button onclick="document.getElementById('googleLoginBtn').click()" class="btn-primary">Logg inn</button>
                    </div>
                    
                    <!-- User info (shown when logged in) -->
                    <div id="myAttendanceUserInfo" class="hidden mb-4">
                      <div class="p-3 rounded-lg bg-brand-50 dark:bg-brand-950 border border-brand-200 dark:border-brand-800">
                        <div id="myAttendanceUserName" class="font-semibold"></div>
                        <div id="myAttendanceUserDetails" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></div>
                      </div>
                    </div>
                    
                    <!-- Statistics (shown when logged in) -->
                    <div id="myAttendanceStats" class="hidden">
                      <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span>Totale økter:</span>
                          <span id="myTotalSessions" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between">
                          <span>Påmeldt til:</span>
                          <span id="myRegisteredSessions" class="font-semibold text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between">
                          <span>Møtt opp på:</span>
                          <span id="myAttendedSessions" class="font-semibold text-green-600">0</span>
                        </div>
                        <div class="flex justify-between">
                          <span>Oppmøte %:</span>
                          <span id="myAttendanceRate" class="font-semibold">0%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Calendar view -->
              <div class="lg:col-span-3">
                <div class="card">
                  <div class="card-header">
                    <h2 class="card-title">Mine økter</h2>
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                      <div class="flex items-center gap-2">
                        <input id="myAttendanceSearch" type="search" placeholder="Søk økter" class="input">
                        <select id="myAttendanceFilter" class="input">
                          <option value="all">Alle økter</option>
                          <option value="registered">Kun påmeldte</option>
                          <option value="attended">Kun møtt opp</option>
                          <option value="missed">Kun ikke møtt</option>
                        </select>
                      </div>
                      <div class="flex items-center gap-2">
                        <label for="dateFrom" class="text-sm font-medium text-gray-700 dark:text-gray-300">Fra:</label>
                        <input id="dateFrom" type="date" class="input text-sm">
                        <label for="dateTo" class="text-sm font-medium text-gray-700 dark:text-gray-300">Til:</label>
                        <input id="dateTo" type="date" class="input text-sm">
                        <button id="clearDateFilter" class="btn-secondary text-sm px-3 py-1">Nullstill</button>
                      </div>
                    </div>
                  </div>
                  <div class="p-4">
                    <div id="myAttendanceEmpty" class="text-center text-gray-500 py-8">
                      Velg deg selv for å se dine økter
                    </div>
                    <div id="myAttendanceGrid" class="hidden grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
                  </div>
                  <div class="px-4 pb-4">
                    <div class="flex items-center gap-4 text-xs text-gray-500">
                      <div class="flex items-center gap-1">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span>Møtt opp</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        <span>Påmeldt, ikke møtt</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                        <span>Ikke deltatt</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Reports View -->
          <section id="view-reports" class="view hidden">
            <div class="max-w-7xl mx-auto">
              <div class="card">
                <div class="card-header">
                  <h2 class="card-title">Bulldøk Leaderboard</h2>
                  <button id="refreshReportsBtn" class="btn-secondary">Oppdater</button>
                </div>
                <div id="topAttendees" class="p-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
              </div>
            </div>
          </section>

          <!-- Import/Export View -->
          <section id="view-io" class="view hidden">
            <div id="ioAdminRequired" class="text-center py-12">
              <div class="max-w-sm mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 mx-auto text-gray-400 mb-4"><path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM12 7C13.1 7 14 7.9 14 9C14 10.1 13.1 11 12 11C10.9 11 10 10.1 10 9C10 7.9 10.9 7 12 7ZM12 13C13.5 13 16 13.75 16 15.25V17H8V15.25C8 13.75 10.5 13 12 13Z"/></svg>
                <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Admin tilgang påkrevd</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-6">Import og eksport av data krever admin-tilgang for å beskytte sensitive klubbdata.</p>
                <button onclick="document.getElementById('adminLoginBtn').click()" class="btn-primary">Logg inn som admin</button>
              </div>
            </div>
            <div id="ioContent" class="grid gap-6 lg:grid-cols-2 hidden">
              <div class="card">
                <div class="card-header">
                  <h2 class="card-title">Eksporter</h2>
                   <div class="flex gap-2">
                    <button id="exportJsonBtn" class="btn-secondary">Eksporter JSON</button>
                    <button id="exportMembersCsvBtn" class="btn-secondary">Medlemmer CSV</button>
                    <button id="exportSessionsCsvBtn" class="btn-secondary">Økter CSV</button>
                    <button id="exportAttendanceCsvBtn" class="btn-secondary">Oppmøte CSV</button>
                   </div>
                 </div>
                <div class="p-4 text-sm text-gray-600 dark:text-gray-400">Last ned data for sikkerhetskopi eller rapportering.</div>
              </div>
              <div class="card">
                <div class="card-header">
                  <h2 class="card-title">Importer</h2>
                   <div></div>
                 </div>
                 <div class="p-4 space-y-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Gjenopprett fra en tidligere eksportert JSON-fil. Dette vil erstatte alle nåværende data.</p>
                   <input id="importJsonInput" type="file" accept="application/json" class="input" />
                  <button id="importJsonBtn" class="btn-danger">Importer JSON</button>
                 </div>
               </div>
             </div>
           </section>
        </div>
      </main>

      <footer class="border-t border-gray-200 dark:border-gray-800 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-xs text-gray-500 dark:text-gray-400">
          <div class="flex items-center justify-between">
            <span>© <span id="year"></span> Bulldøk — made by Magnus J. Moldekleiv</span>
            <span>Bulldøk dev inc.</span>
          </div>
        </div>
      </footer>
    </div>

    <!-- Add Member to Attendance dialog -->
    <dialog id="addMemberDialog" class="rounded-xl backdrop:bg-black/40 p-0 w-full max-w-xl">
      <div class="card !rounded-xl">
        <div class="card-header">
          <h3 class="card-title">Legg til medlem i økt</h3>
           <form class="flex-1 flex justify-end">
            <input id="addMemberSearch" type="search" placeholder="Søk medlemmer" class="input w-64" />
          </form>
        </div>
        <div class="p-2 max-h-[60vh] overflow-y-auto">
          <ul id="addMemberList" class="divide-y divide-gray-100 dark:divide-gray-800"></ul>
        </div>
        <div class="flex justify-end gap-2 p-3 border-t border-gray-100 dark:border-gray-800">
          <button data-close-dialog class="btn-secondary">Lukk</button>
        </div>
      </div>
    </dialog>

    <!-- Admin Login dialog -->
    <dialog id="adminLoginDialog" class="rounded-xl backdrop:bg-black/40 p-0 w-full max-w-md">
      <div class="card !rounded-xl">
        <div class="card-header">
          <h3 class="card-title">Admin Login</h3>
          <div></div>
        </div>
        <form id="adminLoginForm" class="p-4 space-y-4">
          <div>
            <label class="label">Admin-passord</label>
            <input id="adminPasswordInput" type="password" class="input" placeholder="Skriv inn passord" required />
          </div>
          <div id="adminLoginError" class="text-sm text-red-600 hidden">Feil passord. Prøv igjen.</div>
          <div class="flex justify-end gap-2">
            <button type="button" data-close-dialog class="btn-secondary">Avbryt</button>
            <button type="submit" class="btn-primary">Logg inn</button>
          </div>
        </form>
      </div>
    </dialog>

    <script>
      // Some tiny helpers to style generic elements
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.add('px-3','py-2','rounded-md','text-sm','font-medium','text-gray-600','dark:text-gray-300','hover:bg-gray-100','dark:hover:bg-gray-900','data-[active=true]:bg-gray-200','dark:data-[active=true]:bg-gray-800');
      });
      document.querySelectorAll('.card').forEach(c => c.classList.add('bg-white','dark:bg-gray-900','rounded-xl','border','border-gray-200','dark:border-gray-800','shadow-sm'));
      document.querySelectorAll('.card-header').forEach(h => h.classList.add('flex','items-center','justify-between','gap-3','p-4','border-b','border-gray-100','dark:border-gray-800'));
      document.querySelectorAll('.card-title').forEach(t => t.classList.add('text-base','font-semibold'));
      document.querySelectorAll('.card-subtitle').forEach(t => t.classList.add('text-xs','text-gray-500','dark:text-gray-400'));
      document.querySelectorAll('.input').forEach(i => i.classList.add('w-full','px-3','py-2','rounded-md','border','border-gray-200','dark:border-gray-800','bg-white','dark:bg-gray-950','outline-none','focus:ring-2','focus:ring-brand-400'));
      document.querySelectorAll('.btn-primary').forEach(b => b.classList.add('inline-flex','items-center','gap-2','px-3','py-2','rounded-md','bg-brand-600','text-white','hover:bg-brand-700'));
      document.querySelectorAll('.btn-secondary').forEach(b => b.classList.add('inline-flex','items-center','gap-2','px-3','py-2','rounded-md','border','border-gray-200','dark:border-gray-800','hover:bg-gray-100','dark:hover:bg-gray-900'));
      document.querySelectorAll('.btn-danger').forEach(b => b.classList.add('inline-flex','items-center','gap-2','px-3','py-2','rounded-md','bg-red-600','text-white','hover:bg-red-700'));
      document.querySelectorAll('.checkbox').forEach(c => c.classList.add('w-4','h-4','rounded','border','border-gray-300','dark:border-gray-700','text-brand-600','focus:ring-brand-500'));
      document.querySelectorAll('.stat').forEach(s => s.classList.add('p-4','rounded-lg','bg-gray-50','dark:bg-gray-950','border','border-gray-200','dark:border-gray-800'));
      document.querySelectorAll('.stat-label').forEach(s => s.classList.add('text-xs','text-gray-500','dark:text-gray-400'));
      document.querySelectorAll('.stat-value').forEach(s => s.classList.add('text-2xl','font-semibold'));
      document.getElementById('year').textContent = new Date().getFullYear();
    </script>

    <!-- Google Authentication Script -->
    <script>
      let currentUser = null;
      let availableSessions = [];
      
      // Check authentication status on page load
      async function checkAuthStatus() {
        try {
          console.log('Checking auth status...');
          const response = await fetch('/api/auth/user');
          const data = await response.json();
          
          console.log('Auth response:', data);
          
          if (data.authenticated) {
            currentUser = data.user;
            updateLoginUI(true);
            console.log('User authenticated:', currentUser);
          } else {
            currentUser = null;
            updateLoginUI(false);
            console.log('User not authenticated');
          }
        } catch (error) {
          console.error('Error checking auth status:', error);
          updateLoginUI(false);
        }
      }
      
      // Update login UI based on authentication status
      function updateLoginUI(isLoggedIn) {
        const loginBtn = document.getElementById('googleLoginBtn');
        const loginStatus = document.getElementById('loginStatus');
        
        if (isLoggedIn && currentUser) {
          loginBtn.classList.remove('border-blue-200', 'dark:border-blue-800', 'bg-blue-50', 'dark:bg-blue-900/20');
          loginBtn.classList.add('border-green-200', 'dark:border-green-800', 'bg-green-50', 'dark:bg-green-900/20', 'text-green-700', 'dark:text-green-300');
          loginStatus.textContent = currentUser.name || currentUser.email;
          loginBtn.title = 'Klikk for å logge ut';
        } else {
          loginBtn.classList.remove('border-green-200', 'dark:border-green-800', 'bg-green-50', 'dark:bg-green-900/20', 'text-green-700', 'dark:text-green-300');
          loginBtn.classList.add('border-blue-200', 'dark:border-blue-800', 'bg-blue-50', 'dark:bg-blue-900/20', 'text-blue-700', 'dark:text-blue-300');
          loginStatus.textContent = 'Login med Google';
          loginBtn.title = 'Logg inn med Google-kontoen din';
        }
        
        // Update session registration UI
        updateSessionRegistrationUI();
        
        // Update "Mine økter" view if it's currently active
        const myAttendanceView = document.getElementById('view-myattendance');
        if (myAttendanceView && !myAttendanceView.classList.contains('hidden')) {
          updateMyAttendanceView();
        }
      }
      
      // Handle Google login/logout
      document.getElementById('googleLoginBtn').addEventListener('click', function() {
        if (currentUser) {
          // Logout
          window.location.href = '/auth/logout';
        } else {
          // Check if we're in development mode (localhost)
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          
          if (isLocalhost) {
            // For development, show test login options
            const testEmails = [
              'magnusmoldekleivjohansen@gmail.com',
              'anna@example.com',
              'erik@example.com',
              'lisa@example.com'
            ];
            
            const email = prompt(
              'DEVELOPMENT MODE: Choose test email to login as:\n\n' +
              testEmails.map((e, i) => `${i + 1}. ${e}`).join('\n') +
              '\n\nEnter email address:'
            );
            
            if (email && testEmails.includes(email)) {
              window.location.href = `/auth/test-login/${encodeURIComponent(email)}`;
            } else if (email) {
              alert('❌ Test email not found. Please use one of the provided test emails.');
            }
          } else {
            // Production - use real Google OAuth
            window.location.href = '/auth/google';
          }
        }
      });
      
      // Load sessions and update registration UI
      async function loadSessions() {
        try {
          const response = await fetch('/api/sessions');
          availableSessions = await response.json();
          updateSessionRegistrationUI();
        } catch (error) {
          console.error('Error loading sessions:', error);
        }
      }
      
      // Helper function to format date as dd.mm.yyyy
      function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
      }
      
      // Update session registration UI
      function updateSessionRegistrationUI() {
        console.log('updateSessionRegistrationUI called');
        console.log('currentUser:', currentUser);
        console.log('availableSessions:', availableSessions);
        
        const registerSessionsList = document.getElementById('registerSessionsList');
        if (!registerSessionsList || !availableSessions.length) {
          console.log('Missing registerSessionsList or no sessions available');
          return;
        }
        
        // Filter to only show future sessions (including today)
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day
        
        const futureSessions = availableSessions.filter(session => {
          const sessionDate = new Date(session.date);
          sessionDate.setHours(0, 0, 0, 0); // Reset time to start of day
          return sessionDate >= today; // Include today and future dates
        });
        
        console.log('futureSessions:', futureSessions);
        
        if (futureSessions.length === 0) {
          registerSessionsList.innerHTML = '<div class="p-6 text-center text-gray-500">Ingen kommende økter tilgjengelig</div>';
          return;
        }
        
        registerSessionsList.innerHTML = futureSessions.map(session => {
          // Get registration list
          const registrations = session.registrations || [];
          const registrationList = registrations.length > 0 
            ? registrations.join(', ') 
            : 'Ingen påmeldte enda';
          
          console.log('Rendering session:', session.id, 'with registrations:', registrations);
          
          return `
          <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-800">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h4 class="font-semibold text-lg">${session.discipline}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Sted: ${session.location}</p>
                <p class="text-sm text-gray-800 dark:text-gray-200">Dato: ${formatDate(session.date)} • Tid: ${session.start} - ${session.end}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Kapasitet: ${session.capacity} personer</p>
                <div class="mt-2 p-2 bg-gray-50 dark:bg-gray-800 rounded">
                  <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Påmeldte (${registrations.length}):</p>
                  <p class="text-sm text-gray-600 dark:text-gray-400">${registrationList}</p>
                </div>
                ${session.notes ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-2 italic">${session.notes}</p>` : ''}
              </div>
              <div class="ml-4 flex flex-col gap-2">
                ${currentUser ? `
                  <button onclick="registerForSession('${session.id}'); console.log('Register button clicked for session: ${session.id}');" 
                          class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                    Meld på
                  </button>
                  <button onclick="unregisterFromSession('${session.id}'); console.log('Unregister button clicked for session: ${session.id}');" 
                          class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                    Meld av
                  </button>
                ` : `
                  <p class="text-sm text-gray-500 dark:text-gray-400 italic">
                    Logg inn for å melde deg på
                  </p>
                `}
              </div>
            </div>
          </div>
        `}).join('');
      }
      
      // Session registration functions - make them global
      window.registerForSession = async function(sessionId) {
        console.log('registerForSession called with sessionId:', sessionId);
        console.log('currentUser:', currentUser);
        
        if (!currentUser) {
          alert('Du må være logget inn for å melde deg på økter!');
          return;
        }
        
        try {
          console.log('Making request to:', `/api/sessions/${sessionId}/register`);
          const response = await fetch(`/api/sessions/${sessionId}/register`, {
            method: 'POST'
          });
          
          console.log('Response status:', response.status);
          
          if (response.ok) {
            const result = await response.json();
            console.log('Registration success:', result);
            alert('✅ Du er meldt på økten!');
            // Refresh sessions data and UI
            await loadSessions();
            updateSessionRegistrationUI();
            // Update "Mine økter" view if it's active
            const myAttendanceView = document.getElementById('view-myattendance');
            if (myAttendanceView && !myAttendanceView.classList.contains('hidden')) {
              updateMyAttendanceView();
            }
          } else {
            const error = await response.json();
            console.error('Registration error:', error);
            alert('❌ ' + error.error);
          }
        } catch (error) {
          console.error('Error registering:', error);
          alert('❌ Feil ved påmelding');
        }
      }
      
      window.unregisterFromSession = async function(sessionId) {
        if (!currentUser) {
          alert('Du må være logget inn!');
          return;
        }
        
        try {
          const response = await fetch(`/api/sessions/${sessionId}/register`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            alert('✅ Du er avmeldt fra økten!');
            // Refresh sessions data and UI
            await loadSessions();
            updateSessionRegistrationUI();
            // Update "Mine økter" view if it's active
            const myAttendanceView = document.getElementById('view-myattendance');
            if (myAttendanceView && !myAttendanceView.classList.contains('hidden')) {
              updateMyAttendanceView();
            }
          } else {
            const error = await response.json();
            alert('❌ ' + error.error);
          }
        } catch (error) {
          console.error('Error unregistering:', error);
          alert('❌ Feil ved avmelding');
        }
      }
      
      async function markAttendance(sessionId) {
        if (!currentUser) {
          alert('Du må være logget inn!');
          return;
        }
        
        try {
          const response = await fetch(`/api/sessions/${sessionId}/attend`, {
            method: 'POST'
          });
          
          if (response.ok) {
            alert('✅ Frammøte registrert!');
            // Refresh sessions data and UI
            await loadSessions();
            updateSessionRegistrationUI();
            // Update "Mine økter" view if it's active
            const myAttendanceView = document.getElementById('view-myattendance');
            if (myAttendanceView && !myAttendanceView.classList.contains('hidden')) {
              updateMyAttendanceView();
            }
          } else {
            const error = await response.json();
            alert('❌ ' + error.error);
          }
        } catch (error) {
          console.error('Error marking attendance:', error);
          alert('❌ Feil ved registrering av frammøte');
        }
      }
      
      // Handle URL parameters for login success/logout
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('login') === 'success') {
        alert('✅ Velkommen! Du er nå logget inn.');
        // Remove the parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      if (urlParams.get('logout') === 'success') {
        alert('✅ Du er nå logget ut.');
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Tab navigation functionality
      function showView(targetView) {
        // Hide all views
        document.querySelectorAll('.view').forEach(view => {
          view.classList.add('hidden');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Show target view
        const viewElement = document.getElementById(`view-${targetView}`);
        if (viewElement) {
          viewElement.classList.remove('hidden');
        }
        
        // Add active class to clicked tab button
        const tabButton = document.querySelector(`[data-tab="${targetView}"]`);
        if (tabButton) {
          tabButton.classList.add('active');
        }
        
        // Load specific view data when switching to myattendance
        if (targetView === 'myattendance') {
          updateMyAttendanceView();
        }
        
        // Load specific view data when switching to reports
        if (targetView === 'reports') {
          updateReportsView();
        }
      }

      // Update "Mine økter" view based on login status
      function updateMyAttendanceView() {
        const loginRequired = document.getElementById('myAttendanceLoginRequired');
        const userInfo = document.getElementById('myAttendanceUserInfo');
        const stats = document.getElementById('myAttendanceStats');
        const grid = document.getElementById('myAttendanceGrid');
        const empty = document.getElementById('myAttendanceEmpty');
        
        if (!currentUser) {
          // Show login required message
          loginRequired.classList.remove('hidden');
          userInfo.classList.add('hidden');
          stats.classList.add('hidden');
          grid.classList.add('hidden');
          empty.classList.add('hidden');
        } else {
          // Show user info and load their sessions
          loginRequired.classList.add('hidden');
          userInfo.classList.remove('hidden');
          
          // Display current user info
          document.getElementById('myAttendanceUserName').textContent = currentUser.name || 'Logget inn bruker';
          document.getElementById('myAttendanceUserDetails').textContent = currentUser.email || 'Ingen e-post';
          
          // Load user's attendance data
          loadMyAttendanceData();
        }
      }

      // Load attendance data for the current user
      async function loadMyAttendanceData() {
        if (!currentUser) return;
        
        try {
          // For now, we'll calculate stats from available sessions
          // In a real app, this would be an API call to get user-specific data
          const registeredCount = availableSessions.filter(session => 
            session.registrations && session.registrations.includes(currentUser.name)
          ).length;
          
          const attendedCount = availableSessions.filter(session => 
            session.attendance && session.attendance.includes(currentUser.name)
          ).length;
          
          // Update stats
          document.getElementById('myTotalSessions').textContent = availableSessions.length;
          document.getElementById('myRegisteredSessions').textContent = registeredCount;
          document.getElementById('myAttendedSessions').textContent = attendedCount;
          
          const attendanceRate = registeredCount > 0 ? Math.round((attendedCount / registeredCount) * 100) : 0;
          document.getElementById('myAttendanceRate').textContent = attendanceRate + '%';
          
          // Show stats and load session grid
          document.getElementById('myAttendanceStats').classList.remove('hidden');
          loadMySessionsGrid();
          
        } catch (error) {
          console.error('Error loading attendance data:', error);
        }
      }

      // Load and display user's sessions in the grid
      function loadMySessionsGrid() {
        const grid = document.getElementById('myAttendanceGrid');
        const empty = document.getElementById('myAttendanceEmpty');
        
        if (!currentUser || !availableSessions) {
          empty.classList.remove('hidden');
          grid.classList.add('hidden');
          return;
        }
        
        // Get filter values
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const filterType = document.getElementById('myAttendanceFilter').value;
        
        // Show all past sessions (including today) for attendance registration
        const today = new Date();
        today.setHours(23, 59, 59, 999); // End of today
        
        let filteredSessions = availableSessions.filter(session => {
          const sessionDate = new Date(session.date);
          return sessionDate <= today; // Include today and all past sessions
        });
        
        // Apply date range filter if set
        if (dateFrom || dateTo) {
          filteredSessions = filteredSessions.filter(session => {
            const sessionDate = new Date(session.date);
            let inRange = true;
            
            if (dateFrom) {
              const fromDate = new Date(dateFrom);
              fromDate.setHours(0, 0, 0, 0);
              inRange = inRange && sessionDate >= fromDate;
            }
            
            if (dateTo) {
              const toDate = new Date(dateTo);
              toDate.setHours(23, 59, 59, 999);
              inRange = inRange && sessionDate <= toDate;
            }
            
            return inRange;
          });
        }
        
        // Apply dropdown filter independently
        if (filterType !== 'all') {
          filteredSessions = filteredSessions.filter(session => {
            const isRegistered = session.registrations && session.registrations.includes(currentUser.name);
            const hasAttended = session.attendance && session.attendance.includes(currentUser.name);
            
            switch (filterType) {
              case 'registered':
                return isRegistered;
              case 'attended':
                return hasAttended;
              case 'missed':
                return isRegistered && !hasAttended;
              default:
                return true;
            }
          });
        }
        
        // Sort by date (most recent first)
        filteredSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
        // Sort by date (most recent first)
        filteredSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (filteredSessions.length === 0) {
          empty.classList.remove('hidden');
          grid.classList.add('hidden');
          
          // Generate appropriate empty message based on active filters
          let emptyMessage = 'Ingen økter funnet';
          const hasDateFilter = dateFrom || dateTo;
          const hasDropdownFilter = filterType !== 'all';
          
          if (hasDateFilter && hasDropdownFilter) {
            emptyMessage = `Ingen økter funnet som matcher datofilter og "${document.getElementById('myAttendanceFilter').selectedOptions[0].text.toLowerCase()}".`;
          } else if (hasDateFilter) {
            emptyMessage = 'Ingen økter funnet i valgte datoområde.';
          } else if (hasDropdownFilter) {
            emptyMessage = `Ingen økter funnet som matcher "${document.getElementById('myAttendanceFilter').selectedOptions[0].text.toLowerCase()}".`;
          } else {
            emptyMessage = 'Ingen tidligere økter å registrere oppmøte for.';
          }
          
          empty.textContent = emptyMessage;
          return;
        }
        
        // Show sessions grid
        empty.classList.add('hidden');
        grid.classList.remove('hidden');
        
        // Generate session cards
        grid.innerHTML = filteredSessions.map(session => {
          const isRegistered = session.registrations && session.registrations.includes(currentUser.name);
          const hasAttended = session.attendance && session.attendance.includes(currentUser.name);
          const sessionDate = new Date(session.date);
          const isToday = sessionDate.toDateString() === new Date().toDateString();
          
          let statusBadges = [];
          let buttonText = '';
          let buttonClass = '';
          
          // Registration status badge
          if (isRegistered) {
            statusBadges.push('<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">📝 Påmeldt</span>');
          } else {
            statusBadges.push('<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400">Ikke påmeldt</span>');
          }
          
          // Attendance status badge and button logic
          if (hasAttended) {
            statusBadges.push('<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">✅ Møtt opp</span>');
            buttonText = 'Fjern oppmøte';
            buttonClass = 'bg-red-600 hover:bg-red-700';
          } else {
            statusBadges.push('<span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200">❌ Ikke møtt</span>');
            buttonText = 'Registrer oppmøte';
            buttonClass = 'bg-green-600 hover:bg-green-700';
          }
          
          return `
            <div class="p-4 rounded-lg border border-gray-200 dark:border-gray-800 hover:border-brand-300 dark:hover:border-brand-700 transition-colors">
              <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                  <h3 class="font-semibold text-lg text-gray-900 dark:text-gray-100">${session.discipline}</h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">Sted: ${session.location}</p>
                  <p class="text-sm text-gray-600 dark:text-gray-400">Dato: ${formatDate(session.date)} ${isToday ? '(i dag)' : ''}</p>
                </div>
                <div class="flex flex-col gap-1 items-end">
                  ${statusBadges.join('')}
                </div>
              </div>
              <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400 mb-3">
                <div>Tid: ${session.start} - ${session.end}</div>
                <div>Kapasitet: ${session.capacity} personer</div>
                ${session.notes ? `<div class="italic">${session.notes}</div>` : ''}
              </div>
              <button onclick="toggleAttendance('${session.id}', ${hasAttended})" 
                      class="w-full px-3 py-2 ${buttonClass} text-white text-sm rounded hover:opacity-90 transition-opacity">
                ${buttonText}
              </button>
            </div>
          `;
        }).join('');
      }

      // Toggle attendance for a session
      window.toggleAttendance = async function(sessionId, currentlyAttended) {
        if (!currentUser) return;
        
        try {
          const action = currentlyAttended ? 'remove' : 'add';
          console.log(`Toggling attendance: ${action} user ${currentUser.email} for session ${sessionId}`);
          
          const response = await fetch('/api/attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              sessionId: sessionId,
              action: action
            })
          });
          
          if (response.ok) {
            console.log('Attendance toggled successfully');
            // Reload sessions data and update the view
            await loadSessions();
            updateMyAttendanceView();
          } else {
            const error = await response.text();
            console.error('Failed to toggle attendance:', error);
            alert('Kunne ikke oppdatere oppmøte. Prøv igjen.');
          }
        } catch (error) {
          console.error('Error toggling attendance:', error);
          alert('Feil ved oppdatering av oppmøte. Sjekk nettverksforbindelse.');
        }
      }

      // Update reports view with leaderboard
      function updateReportsView() {
        console.log('Updating reports view');
        
        // Update leaderboard
        updateLeaderboard();
      }

      // Update leaderboard with top attendees
      function updateLeaderboard() {
        const topAttendeesElement = document.getElementById('topAttendees');
        
        if (!availableSessions || availableSessions.length === 0) {
          topAttendeesElement.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12"><div class="text-4xl mb-4">📊</div><h3 class="text-lg font-semibold mb-2">Ingen data tilgjengelig</h3><p class="text-sm">Leaderboard vil vises når det finnes oppmøtedata.</p></div>';
          return;
        }

        // Count attendance for each member
        const attendanceCount = {};
        const memberNames = {};
        let totalSessions = 0;

        // Count total past sessions for attendance rate calculation
        const today = new Date();
        const pastSessions = availableSessions.filter(session => {
          const sessionDate = new Date(session.date);
          return sessionDate <= today;
        });
        totalSessions = pastSessions.length;

        pastSessions.forEach(session => {
          if (session.attendance) {
            session.attendance.forEach(memberName => {
              if (!attendanceCount[memberName]) {
                attendanceCount[memberName] = 0;
                memberNames[memberName] = memberName;
              }
              attendanceCount[memberName]++;
            });
          }
        });

        // Convert to array and sort by attendance count
        const leaderboard = Object.entries(attendanceCount)
          .map(([name, count]) => ({ 
            name, 
            count, 
            attendanceRate: totalSessions > 0 ? Math.round((count / totalSessions) * 100) : 0
          }))
          .sort((a, b) => b.count - a.count);

        if (leaderboard.length === 0) {
          topAttendeesElement.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12"><div class="text-4xl mb-4">👤</div><h3 class="text-lg font-semibold mb-2">Ingen oppmøtedata funnet</h3><p class="text-sm">Medlemmer vil vises her når de registrerer oppmøte på økter.</p></div>';
          return;
        }

        // Generate leaderboard HTML
        topAttendeesElement.innerHTML = leaderboard.map((member, index) => {
          const position = index + 1;
          let badgeClass = '';
          let rankIcon = '';
          
          if (position === 1) {
            badgeClass = 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-yellow-900';
            rankIcon = '🏆';
          } else if (position === 2) {
            badgeClass = 'bg-gradient-to-r from-gray-300 to-gray-500 text-gray-900';
            rankIcon = '🥈';
          } else if (position === 3) {
            badgeClass = 'bg-gradient-to-r from-amber-400 to-amber-600 text-amber-900';
            rankIcon = '🥉';
          } else {
            badgeClass = 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
            rankIcon = position <= 10 ? '⭐' : '👤';
          }

          return `
            <div class="relative p-5 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-brand-400 dark:hover:border-brand-500 transition-all duration-200 hover:shadow-lg bg-white dark:bg-gray-800">
              ${position <= 3 ? '<div class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-white dark:bg-gray-800 flex items-center justify-center text-lg border-2 border-gray-200 dark:border-gray-700">' + rankIcon + '</div>' : ''}
              <div class="flex items-center space-x-4">
                <div class="flex items-center justify-center w-12 h-12 rounded-full ${badgeClass} font-bold text-lg">
                  ${position <= 3 ? rankIcon : position}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-lg text-gray-900 dark:text-gray-100 truncate">${member.name}</div>
                  <div class="flex items-center space-x-3 mt-1">
                    <span class="text-sm text-gray-600 dark:text-gray-400">
                      <span class="font-medium text-brand-600 dark:text-brand-400">${member.count}</span> økter
                    </span>
                    <span class="text-xs px-2 py-1 rounded-full ${member.attendanceRate >= 80 ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : member.attendanceRate >= 60 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' : 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400'}">
                      ${member.attendanceRate}% rate
                    </span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Add a summary at the top if there are members
        if (leaderboard.length > 0) {
          const totalMembers = leaderboard.length;
          const totalAttendances = leaderboard.reduce((sum, member) => sum + member.count, 0);
          const avgAttendanceRate = Math.round(leaderboard.reduce((sum, member) => sum + member.attendanceRate, 0) / totalMembers);
          
          const summaryHtml = `
            <div class="col-span-full mb-4 p-4 bg-gradient-to-r from-brand-50 to-brand-100 dark:from-brand-900/20 dark:to-brand-800/20 rounded-lg border border-brand-200 dark:border-brand-800">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <h3 class="text-lg font-semibold text-brand-900 dark:text-brand-100">
                  🎯 Leaderboard Oversikt
                </h3>
                <div class="flex flex-wrap gap-4 text-sm">
                  <div class="bg-white dark:bg-gray-800 px-3 py-1 rounded-full border border-brand-200 dark:border-brand-700">
                    <span class="text-gray-600 dark:text-gray-400">Aktive medlemmer:</span>
                    <span class="font-semibold text-brand-700 dark:text-brand-300 ml-1">${totalMembers}</span>
                  </div>
                  <div class="bg-white dark:bg-gray-800 px-3 py-1 rounded-full border border-brand-200 dark:border-brand-700">
                    <span class="text-gray-600 dark:text-gray-400">Total oppmøte:</span>
                    <span class="font-semibold text-brand-700 dark:text-brand-300 ml-1">${totalAttendances}</span>
                  </div>
                  <div class="bg-white dark:bg-gray-800 px-3 py-1 rounded-full border border-brand-200 dark:border-brand-700">
                    <span class="text-gray-600 dark:text-gray-400">Snitt rate:</span>
                    <span class="font-semibold text-brand-700 dark:text-brand-300 ml-1">${avgAttendanceRate}%</span>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          topAttendeesElement.innerHTML = summaryHtml + topAttendeesElement.innerHTML;
        }
      }

      // Add click handlers to all tab buttons
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
          const tab = button.getAttribute('data-tab');
          showView(tab);
        });
      });

      // Add refresh reports button handler
      document.getElementById('refreshReportsBtn').addEventListener('click', () => {
        updateReportsView();
      });

      // Add dropdown filter event listener for myattendance view
      document.getElementById('myAttendanceFilter').addEventListener('change', () => {
        if (!document.getElementById('view-myattendance').classList.contains('hidden')) {
          loadMySessionsGrid();
        }
      });

      // Add date filter event listeners
      document.getElementById('dateFrom').addEventListener('change', () => {
        if (!document.getElementById('view-myattendance').classList.contains('hidden')) {
          loadMySessionsGrid();
        }
      });

      document.getElementById('dateTo').addEventListener('change', () => {
        if (!document.getElementById('view-myattendance').classList.contains('hidden')) {
          loadMySessionsGrid();
        }
      });

      // Add clear date filter button event listener
      document.getElementById('clearDateFilter').addEventListener('click', () => {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        if (!document.getElementById('view-myattendance').classList.contains('hidden')) {
          loadMySessionsGrid();
        }
      });

      // Admin functionality
      const adminPassword = process.env.ADMIN_PASSWORD || 'change-this-password-in-production';
      let isAdminLoggedIn = false;

      function checkAdminStatus() {
        isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
        updateAdminUI();
      }

      function loginAdmin(password) {
        if (password === adminPassword) {
          isAdminLoggedIn = true;
          sessionStorage.setItem('adminLoggedIn', 'true');
          updateAdminUI();
          return true;
        }
        return false;
      }

      function logoutAdmin() {
        isAdminLoggedIn = false;
        sessionStorage.removeItem('adminLoggedIn');
        updateAdminUI();
      }

      function updateAdminUI() {
        const adminBtn = document.getElementById('adminLoginBtn');
        const adminStatus = document.getElementById('adminStatus');
        const sessionForm = document.getElementById('sessionForm');
        const sessionAdminRequired = document.getElementById('sessionAdminRequired');
        const ioContent = document.getElementById('ioContent');
        const ioAdminRequired = document.getElementById('ioAdminRequired');

        if (isAdminLoggedIn) {
          adminBtn.classList.remove('border-gray-200', 'dark:border-gray-800', 'hover:bg-gray-100', 'dark:hover:bg-gray-900');
          adminBtn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-300', 'dark:border-green-700', 'text-green-700', 'dark:text-green-300');
          adminStatus.textContent = 'Admin (Logg ut)';
          adminBtn.title = 'Du er logget inn som admin. Klikk for å logge ut.';
          
          // Show protected content
          if (sessionForm && sessionAdminRequired) {
            sessionForm.classList.remove('hidden');
            sessionAdminRequired.classList.add('hidden');
          }
          if (ioContent && ioAdminRequired) {
            ioContent.classList.remove('hidden');
            ioAdminRequired.classList.add('hidden');
          }
        } else {
          adminBtn.classList.remove('bg-green-100', 'dark:bg-green-900', 'border-green-300', 'dark:border-green-700', 'text-green-700', 'dark:text-green-300');
          adminBtn.classList.add('border-gray-200', 'dark:border-gray-800', 'hover:bg-gray-100', 'dark:hover:bg-gray-900');
          adminStatus.textContent = 'Admin Login';
          adminBtn.title = 'Klikk for å logge inn som admin';
          
          // Hide protected content
          if (sessionForm && sessionAdminRequired) {
            sessionForm.classList.add('hidden');
            sessionAdminRequired.classList.remove('hidden');
          }
          if (ioContent && ioAdminRequired) {
            ioContent.classList.add('hidden');
            ioAdminRequired.classList.remove('hidden');
          }
        }
      }

      // Admin login event handlers
      document.getElementById('adminLoginBtn').addEventListener('click', () => {
        if (isAdminLoggedIn) {
          if (confirm('Er du sikker på at du vil logge ut som admin?')) {
            logoutAdmin();
          }
        } else {
          document.getElementById('adminLoginDialog').showModal();
        }
      });

      document.getElementById('adminLoginForm').addEventListener('submit', e => {
        e.preventDefault();
        const password = document.getElementById('adminPasswordInput').value;
        const errorDiv = document.getElementById('adminLoginError');
        
        if (loginAdmin(password)) {
          document.getElementById('adminLoginDialog').close();
          document.getElementById('adminPasswordInput').value = '';
          errorDiv.classList.add('hidden');
        } else {
          errorDiv.classList.remove('hidden');
        }
      });

      // Close dialog handlers
      document.querySelectorAll('[data-close-dialog]').forEach(btn => {
        btn.addEventListener('click', e => {
          const dialog = btn.closest('dialog');
          if (dialog) {
            dialog.close();
            // Clear form if it's the admin login dialog
            if (dialog.id === 'adminLoginDialog') {
              document.getElementById('adminPasswordInput').value = '';
              document.getElementById('adminLoginError').classList.add('hidden');
            }
          }
        });
      });

      // Initialize on page load
      window.addEventListener('load', async () => {
        console.log('Page loaded, initializing...');
        await checkAuthStatus();
        await loadSessions();
        
        // Check admin status
        checkAdminStatus();
        
        // Show default view (register)
        showView('register');
        
        // Verify functions are accessible
        console.log('registerForSession function available:', typeof window.registerForSession);
        console.log('unregisterFromSession function available:', typeof window.unregisterFromSession);
      });
    </script>
  </body>
</html>
